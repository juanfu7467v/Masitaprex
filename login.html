<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MASITAPREX | Iniciar Sesión</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
  <style>
    /* ---------------------------------------------------------------------- */
    /* --- VARIABLES Y PALETA DE COLORES (ACTUALIZADA) --- */
    /* ---------------------------------------------------------------------- */
    :root {
        /* Degradado de Púrpura Oscuro a Magenta Claro (Fondo principal) */
        --gradient-dark: #660099; /* Morado/Púrpura Oscuro */
        --gradient-light: #FF0080; /* Magenta/Rosado */
        --primary-gradient: linear-gradient(135deg, var(--gradient-dark), var(--gradient-light)); 
        --primary-gradient-rev: linear-gradient(-45deg, var(--gradient-dark), var(--gradient-light)); 
        
        /* Nuevo: Degradado para texto en modo teléfono (Azul a Verde) */
        --text-color-blue: #007bff; /* Azul */
        --text-color-green: #28a745; /* Verde */
        --text-gradient-mobile: linear-gradient(45deg, var(--text-color-blue), var(--text-color-green));

        /* Ajuste: Fondos */
        --form-bg: rgba(255, 255, 255, 0.2); /* Fondo semitransparente ancho en desktop */
        
        --text-dark: #333;
        --text-light: #fff;
        --text-placeholder-light: rgba(255, 255, 255, 0.7);
        --bg-light: #f4f6f8; 
        
        --input-bg-light: #fff;

        --button-gradient-reverse: linear-gradient(45deg, var(--gradient-light), var(--gradient-dark)); 
        --shadow-color: rgba(102, 0, 153, 0.5); 
        
        --link-color: #ffcc00; /* Amarillo/Dorado para enlaces en fondo oscuro */
    }

    /* ---------------------------------------------------------------------- */
    /* --- ESTILOS BASE Y CUERPO (BODY) --- */
    /* ---------------------------------------------------------------------- */
    html, body {
        margin: 0;
        padding: 0;
        font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-light);
        color: var(--text-dark);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow-x: hidden; /* Evitar scroll horizontal */
        box-sizing: border-box;
    }
    
    /* ---------------------------------------------------------------------- */
    /* --- CONTENEDOR PRINCIPAL (LAPTOP/WEB - PANTALLA GRANDE) --- */
    /* ---------------------------------------------------------------------- */
    .app-container {
        width: 90%;
        max-width: 1000px;
        /* CAMBIO: Alto autoajustable con mínimos y máximos para dejar espacio vertical */
        height: auto; 
        min-height: 80vh; 
        max-height: 90vh;
        margin: 5vh auto; /* Deja espacio en la parte superior e inferior */
        background: var(--primary-gradient);
        border-radius: 15px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        display: flex;
        overflow: hidden;
        transition: all 0.5s ease-in-out;
    }

    /* ---------------------------------------------------------------------- */
    /* --- SECCIÓN DE INFORMACIÓN (COLUMNA IZQUIERDA EN LAPTOP) --- */
    /* ---------------------------------------------------------------------- */
    .info-section {
        flex: 1.2;
        padding: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: var(--text-light);
        text-align: center;
        background: transparent;
    }

    .info-section h1 {
        font-size: 2.5em;
        margin-top: 10px;
        margin-bottom: 20px;
        font-weight: 700;
    }
    
    .logo-container .material-symbols-rounded {
        font-size: 72px;
        color: var(--text-light);
        position: relative;
    }

    .info-section button {
        background: transparent;
        color: var(--text-light);
        border: 2px solid var(--text-light);
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    /* ---------------------------------------------------------------------- */
    /* --- SECCIÓN DE FORMULARIO (COLUMNA DERECHA EN LAPTOP) --- */
    /* ---------------------------------------------------------------------- */
    .form-section {
        flex: 1; 
        background: var(--form-bg); 
        padding: 40px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-radius: 0 15px 15px 0;
        box-sizing: border-box;
    }
    
    .form-section h3 {
        color: var(--text-light);
        font-size: 2em;
        margin-bottom: 25px;
        text-align: center;
        font-weight: 600;
    }

    /* Contenedor que adapta su tamaño (ancho adecuado, no alto innecesario) */
    .form-content {
        display: inline-flex;
        flex-direction: column;
        align-items: center;
        width: auto; 
        padding: 30px; 
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.1); 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        min-width: 350px; 
        transition: all 0.3s ease;
    }

    /* Estilos de los formularios internos */
    .login-form, .register-form, .recover-password-form {
        display: none;
        flex-direction: column;
        align-items: center;
        width: 100%; 
        max-width: 300px;
        position: relative;
    }

    /* Campos de entrada */
    .input-field {
        width: 100%;
        padding: 14px 20px;
        margin-top: 15px;
        font-size: 1.05rem;
        border: none;
        border-radius: 8px;
        background-color: rgba(255, 255, 255, 0.9);
        color: var(--text-dark);
        box-sizing: border-box;
    }

    /* Botón Principal */
    .primary-btn {
        width: 100%; 
        padding: 14px;
        border: none;
        border-radius: 25px;
        font-size: 1.1em;
        cursor: pointer;
        margin-top: 30px;
        font-weight: bold;
        text-transform: uppercase;
        color: var(--text-light);
        background: var(--button-gradient-reverse); 
    }

    /* ---------------------------------------------------------------------- */
    /* --- MEDIA QUERIES (ADAPTACIÓN A MÓVIL/TABLET PEQUEÑA) --- */
    /* ---------------------------------------------------------------------- */
    @media (max-width: 900px) {
        html, body {
            overflow-y: auto; /* Permitir scroll vertical en móvil */
        }

        .app-container {
            width: 100%;
            height: 100vh;
            max-width: none;
            min-height: 100vh;
            border-radius: 0;
            box-shadow: none;
            flex-direction: column;
            justify-content: flex-start; 
            margin: 0; /* Eliminar margen para ocupar toda la pantalla */
        }

        .info-section {
            display: none;
        }
        
        .form-section {
            flex: 1;
            width: 100%;
            border-radius: 0;
            /* CAMBIO: Fondo de la sección completamente transparente */
            background: transparent; 
            padding: 30px 20px;
            justify-content: flex-start; 
        }

        /* En móvil, el contenedor interno es transparente y ocupa todo el ancho */
        .form-content {
            width: 100%;
            padding: 0; 
            background: transparent; /* CAMBIO: Fondo del contenedor del contenido transparente */
            box-shadow: none;
            min-width: unset;
        }

        /* Estilo de título en móvil con degradado Azul/Verde */
        .form-section h3 {
            font-size: 2.2em;
            font-weight: 700;
            /* Aplicar el degradado de texto */
            background: var(--text-gradient-mobile); 
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: #007bff; /* Fallback color */
        }

        /* Ajuste de logo en móvil */
        .logo-mobile {
            display: flex;
            flex-direction: column;
            align-items: center;
            /* Usar texto degradado para el nombre de la app en móvil si se desea */
        }
    }
  </style>
</head>
<body>
    
    <div class="app-container">

        <div class="info-section" id="info-section-content">
            <div class="logo-container">
                <span class="material-symbols-rounded">settings_suggest</span>
                <h1>MASITAPREX</h1>
            </div>
            
            <div id="info-login-state">
                <p>Ingresa para acceder a todos los servicios y beneficios que MASITAPREX tiene para ti.</p>
                <button onclick="showRegisterForm()">
                    Registrarse
                </button>
            </div>
            
            <div id="info-register-state" style="display: none;">
                <p>Si ya tienes una cuenta, puedes acceder rápidamente con tus credenciales.</p>
                <button onclick="showLoginForm()">
                    Iniciar Sesión
                </button>
            </div>
            
            <div class="social-or-text">
                O ingresa con
                <div class="social-circle-icons">
                    <a href="#" aria-label="Ingresar con Google"></a>
                    <a href="#" aria-label="Ingresar con Facebook"></a>
                    <a href="#" aria-label="Ingresar con Apple"></a>
                </div>
            </div>
        </div>

        <div class="form-section">
            
            <div class="logo-mobile">
                <span class="material-symbols-rounded">settings_suggest</span>
                <h3>MASITAPREX</h3>
            </div>

            <div class="form-content">
                
                <div id="login-form" class="login-form">
                    <h3>Bienvenido</h3>
                    
                    <input type="email" id="login-email" placeholder="Usuario / Correo electrónico" autocomplete="email" class="input-field">
                    
                    <div class="password-container">
                        <input type="password" id="login-password" placeholder="Contraseña" autocomplete="current-password" class="input-field">
                        <span class="material-icons toggle-password" id="toggle-login-password" onclick="togglePasswordVisibility('login-password', 'toggle-login-password')">visibility</span>
                    </div>

                    <div class="form-text-link">
                        <a href="#" onclick="showRecoverPasswordForm(); return false;">¿Olvidaste la Contraseña?</a>
                    </div>

                    <button class="primary-btn" onclick="loginWithEmail()">
                        Iniciar sesión
                    </button>
                    
                    <div class="form-text-link" style="margin-top: 25px;">
                        ¿No tienes una cuenta? <a href="#" onclick="showRegisterForm(); return false;">Registrarse</a>
                    </div>
                </div>

                <div id="register-form" class="register-form">
                    <h3>Crear Cuenta</h3>
                    
                    <input type="text" id="register-name" placeholder="Tu nombre" class="input-field">

                    <input type="email" id="register-email" placeholder="Tu E-mail" autocomplete="email" class="input-field">
                    
                    <div class="password-container">
                        <input type="password" id="register-password" placeholder="Contraseña" autocomplete="new-password" class="input-field">
                        <span class="material-icons toggle-password" id="toggle-register-password" onclick="togglePasswordVisibility('register-password', 'toggle-register-password')">visibility</span>
                    </div>
                    
                    <div class="password-container">
                        <input type="password" id="register-confirm-password" placeholder="Confirmar Contraseña" autocomplete="new-password" class="input-field">
                        <span class="material-icons toggle-password" id="toggle-register-confirm-password" onclick="togglePasswordVisibility('register-confirm-password', 'toggle-register-confirm-password')">visibility</span>
                    </div>

                    <div class="register-terms-check">
                         <input type="checkbox" id="accept-terms">
                         <label for="accept-terms" style="color: var(--text-placeholder-light); font-size: 0.9em; text-align: left;">
                             Acepto los <a href="terminos-condiciones.html">Términos</a> y la <a href="politica-privacidad.html">Política de Privacidad</a>
                         </label>
                    </div>

                    <button class="primary-btn" onclick="registerNewAccount()">
                        Registrarse
                    </button>
                    
                    <div class="form-text-link" style="margin-top: 25px;">
                        ¿Ya tienes una cuenta? <a href="#" onclick="showLoginForm(); return false;">Iniciar sesión</a>
                    </div>
                </div>

                <div id="recover-password-form" class="recover-password-form">
                    <h3>Recuperar</h3>
                    <p style="text-align: center; color: var(--text-placeholder-light); margin-top: -10px;">Ingresa tu correo para el enlace.</p>
                    
                    <input type="email" id="recover-email" placeholder="Correo electrónico" class="input-field">

                    <button class="primary-btn" onclick="recoverPassword()">
                        Enviar Enlace
                    </button>
                    
                    <div class="form-text-link">
                        <a href="#" onclick="showLoginForm(); return false;">Volver al Login</a>
                    </div>
                </div>
            </div>
            
            <div id="form-message-tooltip"></div>
        </div>
    </div> 
    
    <div id="loading-indicator">
      <div class="pulsing-circle"></div>
      <div class="pulsing-circle delay-1"></div>
      <div class="pulsing-circle delay-2"></div>
    </div>
    
  <script type="module">
    // --- LÓGICA DE FIREBASE Y JS (Sin cambios en la lógica, solo en las llamadas a formularios) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
      onAuthStateChanged, sendPasswordResetEmail 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


    // Tu configuración de Firebase para la aplicación web
    const firebaseConfig = {
      apiKey: "AIzaSyAvzBfVUN_xRw-fuBEZdhoTasTMws1yERg", 
      authDomain: "consulta-pe-abf99.firebaseapp.com",
      projectId: "consulta-pe-abf99",
      storageBucket: "consulta-pe-abf99.firebasestorage.app",
      messagingSenderId: "610275972424",
      appId: "1:610275972424:web:01a90ea3b00fcb1fc64f7d", 
      measurementId: "G-G5MS9N3PCH" 
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app); 
    const db = getFirestore(app); 

    // --- Referencias a elementos del DOM ---
    const formMessageTooltip = document.getElementById('form-message-tooltip'); 
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const recoverPasswordForm = document.getElementById('recover-password-form');
    const loadingIndicator = document.getElementById('loading-indicator'); 
    
    // Elementos de la sección de información (Desktop)
    const infoLoginState = document.getElementById('info-login-state');
    const infoRegisterState = document.getElementById('info-register-state');
    const infoSection = document.getElementById('info-section-content');

    // --- Funciones de utilidad ---

    function showMessage(msg, type) {
        if (formMessageTooltip) {
            formMessageTooltip.textContent = msg;
            formMessageTooltip.className = `form-message-tooltip active ${type}`; 
            
            setTimeout(() => {
                formMessageTooltip.classList.remove('active'); 
            }, 5000);
        }
    }

    function showLoadingOverlay() {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'flex';
        }
    }

    function hideLoadingOverlay() {
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
    }

    // --- Funciones para manejar la visibilidad de los formularios (Adaptadas al nuevo diseño) ---
    function hideAllForms() {
        if (loginForm) loginForm.style.display = 'none';
        if (registerForm) registerForm.style.display = 'none';
        if (recoverPasswordForm) recoverPasswordForm.style.display = 'none';
        if (infoLoginState) infoLoginState.style.display = 'none';
        if (infoRegisterState) infoRegisterState.style.display = 'none';
        if (formMessageTooltip) formMessageTooltip.classList.remove('active'); 
    }

    window.showRegisterForm = () => {
        hideAllForms(); 
        if (registerForm) registerForm.style.display = 'flex';
        if (infoRegisterState) infoRegisterState.style.display = 'block'; // Muestra estado de Login en info
        if (infoLoginState) infoLoginState.style.display = 'none';
        hideLoadingOverlay(); 
    };

    window.showLoginForm = () => {
        hideAllForms(); 
        if (loginForm) loginForm.style.display = 'flex';
        if (infoLoginState) infoLoginState.style.display = 'block'; // Muestra estado de Registro en info
        if (infoRegisterState) infoRegisterState.style.display = 'none';
        hideLoadingOverlay(); 
    };

    window.showRecoverPasswordForm = () => {
        hideAllForms(); 
        if (recoverPasswordForm) recoverPasswordForm.style.display = 'flex';
        // Para la recuperación, mantenemos el estado de registro en la sección de info (para volver)
        if (infoLoginState) infoLoginState.style.display = 'block'; 
        if (infoRegisterState) infoRegisterState.style.display = 'none';
        hideLoadingOverlay(); 
    };


    // --- Función para alternar la visibilidad de la contraseña ---
    window.togglePasswordVisibility = (inputId, iconId) => {
        const passwordInput = document.getElementById(inputId);
        const toggleIcon = document.getElementById(iconId);

        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            toggleIcon.textContent = 'visibility_off';
        } else {
            passwordInput.type = 'password';
            toggleIcon.textContent = 'visibility';
        }
    };

    // --- Funciones de autenticación (Mantienen la lógica de Firebase) ---

    window.loginWithEmail = async () => {
      const emailInput = document.getElementById('login-email');
      const passwordInput = document.getElementById('login-password');
      const email = emailInput ? emailInput.value : '';
      const password = passwordInput ? passwordInput.value : '';

      if (!email || !password || !/\S+@\S+\.\S+/.test(email)) {
          showMessage('Ingresa un correo y contraseña válidos.', 'error');
          return; 
      }

      showLoadingOverlay(); 
      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        await saveUserProfile(userCredential.user); 
        showMessage('Inicio de sesión exitoso!', 'success'); 
        redirectToNextPage(); 
      } catch (error) {
        hideLoadingOverlay(); 
        let errorMessage = 'Error al iniciar sesión. Verifica tu correo y contraseña.';
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'Usuario no encontrado.';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'Contraseña incorrecta.';
        }
        showMessage(errorMessage, 'error');
      }
    };

    window.registerNewAccount = async () => {
      const nameInput = document.getElementById('register-name');
      const emailInput = document.getElementById('register-email');
      const passwordInput = document.getElementById('register-password');
      const confirmPasswordInput = document.getElementById('register-confirm-password');
      const termsCheckbox = document.getElementById('accept-terms');

      const name = nameInput ? nameInput.value.trim() : '';
      const email = emailInput ? emailInput.value.trim() : '';
      const password = passwordInput ? passwordInput.value : '';
      const confirmPassword = confirmPasswordInput ? confirmPasswordInput.value : '';

      if (!name || !email || !password || !confirmPassword) {
          showMessage('Por favor, completa todos los campos.', 'error'); return;
      }
      if (!/\S+@\S+\.\S+/.test(email)) {
          showMessage('Ingresa un formato de correo electrónico válido.', 'error'); return;
      }
      if (password.length < 6) {
          showMessage('La contraseña debe tener al menos 6 caracteres.', 'error'); return;
      }
      if (password !== confirmPassword) {
          showMessage('Las contraseñas no coinciden.', 'error'); return;
      }
      if (!termsCheckbox.checked) {
          showMessage('Debes aceptar los Términos y la Política de Privacidad.', 'error'); return;
      }

      showLoadingOverlay(); 
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        await saveUserProfile(userCredential.user, name); 
        showMessage('¡Cuenta creada exitosamente! Iniciando sesión...', 'success');
        redirectToNextPage();
      } catch (error) {
        hideLoadingOverlay(); 
        let errorMessage = 'Error al registrarse. Intenta con otro correo.';
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'Este correo ya está en uso. ¿Deseas iniciar sesión?';
        }
        showMessage(errorMessage, 'error');
      }
    };

    window.recoverPassword = async () => {
        const emailInput = document.getElementById('recover-email');
        const email = emailInput ? emailInput.value.trim() : '';

        if (!email || !/\S+@\S+\.\S+/.test(email)) {
            showMessage('Ingresa un correo electrónico válido para recuperar la contraseña.', 'error');
            return;
        }

        showLoadingOverlay(); 
        try {
            await sendPasswordResetEmail(auth, email);
            hideLoadingOverlay(); 
            showMessage('Se ha enviado un correo de recuperación. Revisa tu bandeja de entrada.', 'success');
            setTimeout(() => {
                showLoginForm(); 
            }, 3000); 
        } catch (error) {
            hideLoadingOverlay(); 
            let errorMessage = 'Error al enviar el correo. Asegúrate de que la dirección sea correcta.';
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'No se encontró una cuenta con ese correo.';
            }
            showMessage(errorMessage, 'error');
        }
    };


    // --- Comprobación inicial del estado de autenticación ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        redirectToNextPage();
      } else {
        setTimeout(() => {
            if (window.location.hash === '#recover') {
                showRecoverPasswordForm();
            } else if (window.location.hash === '#register') {
                showRegisterForm();
            } else {
                showLoginForm(); 
            }
            hideLoadingOverlay(); 
        }, 500); 
      }
    });

    // Manejar el evento popstate para detectar si el usuario regresa con el botón de "atrás" del navegador
    window.addEventListener('popstate', (event) => {
        showLoadingOverlay(); 
        onAuthStateChanged(auth, (user) => {
            if (!user && window.location.hostname.includes('firebaseapp.com')) { 
                window.location.href = "http://action_exit/";
            } else {
                if (!user) {
                    setTimeout(() => {
                        showLoginForm();
                        hideLoadingOverlay();
                    }, 100); 
                } else {
                    hideLoadingOverlay(); 
                }
            }
        });
    });

    // Función para guardar o actualizar el perfil del usuario en Firestore
    async function saveUserProfile(user, name = null) {
      try {
        const userDocRef = doc(db, "users", user.uid);
        await setDoc(userDocRef, {
          email: user.email,
          name: name || user.displayName || user.email.split('@')[0],
          createdAt: serverTimestamp(),
          photoURL: user.photoURL || "" 
        }, { merge: true });
      } catch (error) {
        console.error("Error al guardar el perfil en Firestore:", error);
      }
    }

    // --- Función para la redirección ---
    function redirectToNextPage() {
        window.location.href = "go:rapidas";
    }

    // Al cargar la página, ocultar formularios y mostrar el loading
    document.addEventListener('DOMContentLoaded', () => {
        hideAllForms(); 
        showLoadingOverlay(); 
    });
  </script>

</body>
</html>
